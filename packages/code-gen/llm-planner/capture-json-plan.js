#!/usr/bin/env node

/**
 * Capture the actual JSON plan generated by real LLM
 */

import { ResourceManager } from '@jsenvoy/module-loader';
import { LLMClient } from '@jsenvoy/llm';
import { GenericPlanner } from './src/GenericPlanner.js';
import fs from 'fs';

async function main() {
  const resourceManager = new ResourceManager();
  await resourceManager.initialize();

  const apiKey = resourceManager.get('env.ANTHROPIC_API_KEY');
  if (!apiKey) {
    console.error('‚ùå ANTHROPIC_API_KEY not found');
    process.exit(1);
  }

  const llmClient = new LLMClient({
    provider: 'anthropic',
    apiKey: apiKey,
    model: 'claude-3-sonnet-20240229',
    maxRetries: 2
  });

  const planner = new GenericPlanner({ llmClient, maxRetries: 2 });

  // Simple request with clear allowable actions
  const request = {
    description: 'Create a simple web server with basic routing',
    inputs: ['project-requirements'],
    requiredOutputs: ['web-server', 'api-endpoints'],
    allowableActions: [
      {
        type: 'create-file',
        inputs: ['file-content'],
        outputs: ['file-created']
      },
      {
        type: 'install-dependencies',
        inputs: ['package-list'],
        outputs: ['dependencies-installed']
      },
      {
        type: 'setup-server',
        inputs: ['server-config'],
        outputs: ['server-setup']
      },
      {
        type: 'create-routes',
        inputs: ['route-definitions'],
        outputs: ['routes-created']
      },
      {
        type: 'start-server',
        inputs: ['server-setup', 'routes-created'],
        outputs: ['web-server', 'api-endpoints']
      }
    ]
  };

  console.log('üöÄ Generating plan with real Anthropic Claude API...\n');
  
  try {
    const plan = await planner.createPlan(request);
    
    // Save the JSON plan
    const planJson = plan.toJSON();
    fs.writeFileSync('real-llm-generated-plan.json', JSON.stringify(planJson, null, 2));
    
    console.log('‚úÖ Real LLM generated plan successfully!');
    console.log('üíæ Plan saved to: real-llm-generated-plan.json');
    console.log('\nüìã Generated Plan JSON:');
    console.log('=' .repeat(60));
    console.log(JSON.stringify(planJson, null, 2));
    
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

main().catch(console.error);