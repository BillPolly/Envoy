<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header-info {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .container {
            display: grid;
            grid-template-columns: 250px 1fr 350px;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .search-bar {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .search-bar input {
            flex: 1;
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .search-bar select, .search-bar button {
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        .search-bar button {
            background: #3b82f6;
            border: none;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .search-bar button:hover {
            background: #2563eb;
        }
        
        .log-viewer {
            background: #1e293b;
            border-radius: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .log-viewer-header {
            padding: 1rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-filters {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-btn {
            padding: 0.25rem 0.75rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.8125rem;
            line-height: 1.5;
        }
        
        .log-entry {
            padding: 0.5rem;
            margin-bottom: 2px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            animation: slideIn 0.2s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .log-timestamp {
            color: #64748b;
            white-space: nowrap;
        }
        
        .log-process {
            color: #a78bfa;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .log-level {
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .log-level.error {
            background: #dc2626;
            color: white;
        }
        
        .log-level.warn {
            background: #f59e0b;
            color: white;
        }
        
        .log-level.info {
            background: #3b82f6;
            color: white;
        }
        
        .log-level.debug {
            background: #6b7280;
            color: white;
        }
        
        .log-message {
            flex: 1;
            color: #e2e8f0;
            word-break: break-word;
        }
        
        .correlation-id {
            color: #10b981;
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .process-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .process-card:hover {
            border-color: #3b82f6;
            background: #1e293b;
        }
        
        .process-card.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        
        .process-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .process-info {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        .process-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .process-status.running {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .process-status.stopped {
            background: #ef4444;
        }
        
        .stats-panel {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .stat-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }
        
        .correlation-view {
            background: #0f172a;
            border: 2px solid #10b981;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .correlation-header {
            color: #10b981;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .controls {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }
        
        .control-btn {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: #1e293b;
            border-color: #3b82f6;
        }
        
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: #1e293b;
            border-radius: 4px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }
        
        .connection-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .connection-indicator.connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .connection-indicator.disconnected {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Log Monitoring Dashboard</h1>
        <div class="header-info">
            <span id="session-id">Session: Loading...</span>
            <span id="total-logs">Total Logs: 0</span>
            <span id="active-processes">Active Processes: 0</span>
            <span id="correlation-count">Correlations: 0</span>
        </div>
    </div>
    
    <div class="connection-status">
        <div class="connection-indicator disconnected" id="connection-indicator"></div>
        <span id="connection-text">Disconnected</span>
    </div>
    
    <div class="container">
        <!-- Sidebar: Process List -->
        <div class="sidebar">
            <h3 style="margin-bottom: 1rem;">Monitored Processes</h3>
            <div id="process-list"></div>
            
            <div class="controls">
                <button class="control-btn" onclick="clearLogs()">Clear Logs</button>
                <button class="control-btn" onclick="exportLogs('json')">Export JSON</button>
                <button class="control-btn" onclick="exportLogs('csv')">Export CSV</button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search logs..." />
                <select id="search-mode">
                    <option value="keyword">Keyword</option>
                    <option value="regex">Regex</option>
                    <option value="semantic">Semantic</option>
                    <option value="hybrid">Hybrid</option>
                </select>
                <button onclick="searchLogs()">Search</button>
                <button onclick="clearSearch()">Clear</button>
            </div>
            
            <!-- Log Viewer -->
            <div class="log-viewer">
                <div class="log-viewer-header">
                    <h3>Live Logs</h3>
                    <div class="log-filters">
                        <button class="filter-btn active" data-level="all" onclick="filterLogs('all')">All</button>
                        <button class="filter-btn" data-level="error" onclick="filterLogs('error')">Errors</button>
                        <button class="filter-btn" data-level="warn" onclick="filterLogs('warn')">Warnings</button>
                        <button class="filter-btn" data-level="info" onclick="filterLogs('info')">Info</button>
                        <button class="filter-btn" data-level="debug" onclick="filterLogs('debug')">Debug</button>
                    </div>
                </div>
                <div class="log-container" id="log-container"></div>
            </div>
        </div>
        
        <!-- Right Panel: Statistics -->
        <div class="stats-panel">
            <h3 style="margin-bottom: 1rem;">Statistics</h3>
            
            <div class="stat-card">
                <div class="stat-value" id="logs-per-minute">0</div>
                <div class="stat-label">Logs/Minute</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="recent-errors">0</div>
                <div class="stat-label">Errors (Last 5 Min)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="total-correlations">0</div>
                <div class="stat-label">Correlated Requests</div>
            </div>
            
            <h4 style="margin: 1rem 0 0.5rem;">Log Levels</h4>
            <div id="level-stats"></div>
            
            <h4 style="margin: 1rem 0 0.5rem;">By Process</h4>
            <div id="process-stats"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let sessionId = null;
        let selectedProcess = null;
        let currentFilter = 'all';
        let allLogs = [];
        let stats = {};
        
        // Initialize dashboard
        async function init() {
            connectWebSocket();
            await loadInitialData();
            setInterval(updateStats, 5000);
        }
        
        // Connect to WebSocket for real-time updates
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8081');
            
            ws.onopen = () => {
                console.log('Connected to monitoring server');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                console.log('Disconnected from monitoring server');
                updateConnectionStatus(false);
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        // Handle incoming WebSocket messages
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'init':
                    sessionId = message.sessionId;
                    document.getElementById('session-id').textContent = `Session: ${sessionId.slice(0, 20)}...`;
                    updateProcessList(message.processes);
                    updateStatsDisplay(message.stats);
                    break;
                    
                case 'log':
                    addLogEntry(message.data);
                    if (message.correlationIds && message.correlationIds.length > 0) {
                        highlightCorrelations(message.correlationIds);
                    }
                    break;
                    
                case 'process-exit':
                    updateProcessStatus(message.processId, 'stopped');
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }
        
        // Add a log entry to the display
        function addLogEntry(log) {
            allLogs.push(log);
            
            // Check if log matches current filter
            if (currentFilter !== 'all' && log.level !== currentFilter) {
                return;
            }
            
            // Check if log matches selected process
            if (selectedProcess && log.processId !== selectedProcess) {
                return;
            }
            
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.dataset.level = log.level;
            entry.dataset.process = log.processId;
            
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            
            // Look for correlation IDs in the message
            const message = log.message.replace(
                /\[(req-[\d-]+|trace-[\d-]+|correlation-[\d-]+)\]/g,
                '<span class="correlation-id" onclick="showCorrelation(\'$1\')">[$1]</span>'
            );
            
            entry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-process">[${log.processId}]</span>
                <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
                <span class="log-message">${message}</span>
            `;
            
            container.insertBefore(entry, container.firstChild);
            
            // Keep only last 1000 entries in view
            while (container.children.length > 1000) {
                container.removeChild(container.lastChild);
            }
        }
        
        // Search logs
        async function searchLogs() {
            const query = document.getElementById('search-input').value;
            const mode = document.getElementById('search-mode').value;
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                const response = await fetch(`/api/search?query=${encodeURIComponent(query)}&mode=${mode}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySearchResults(result.matches);
                } else {
                    alert(`Search failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed');
            }
        }
        
        // Display search results
        function displaySearchResults(matches) {
            const container = document.getElementById('log-container');
            container.innerHTML = `<div style="padding: 1rem; background: #0f172a; margin-bottom: 1rem;">
                Search Results: ${matches.length} matches
            </div>`;
            
            matches.forEach(log => addLogEntry(log));
        }
        
        // Clear search
        function clearSearch() {
            document.getElementById('search-input').value = '';
            const container = document.getElementById('log-container');
            container.innerHTML = '';
            
            // Re-add recent logs
            allLogs.slice(-100).forEach(log => addLogEntry(log));
        }
        
        // Filter logs by level
        function filterLogs(level) {
            currentFilter = level;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level === level);
            });
            
            // Filter displayed logs
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                const show = level === 'all' || entry.dataset.level === level;
                entry.style.display = show ? 'flex' : 'none';
            });
        }
        
        // Show correlation
        async function showCorrelation(correlationId) {
            try {
                const response = await fetch(`/api/correlations/${correlationId}`);
                const data = await response.json();
                
                const container = document.getElementById('log-container');
                const correlationView = document.createElement('div');
                correlationView.className = 'correlation-view';
                
                correlationView.innerHTML = `
                    <div class="correlation-header">
                        Correlation: ${correlationId} (${data.processCount} processes)
                    </div>
                `;
                
                data.logs.forEach(log => {
                    const entry = document.createElement('div');
                    entry.style.marginLeft = '1rem';
                    entry.innerHTML = `
                        <span class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
                        <span class="log-process">[${log.processId}]</span>
                        <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
                        <span>${log.message}</span>
                    `;
                    correlationView.appendChild(entry);
                });
                
                container.insertBefore(correlationView, container.firstChild);
            } catch (error) {
                console.error('Failed to load correlation:', error);
            }
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Load processes
                const processResponse = await fetch('/api/processes');
                const processes = await processResponse.json();
                updateProcessList(processes.map(p => p.name));
                
                // Load recent logs
                const logsResponse = await fetch('/api/logs/recent?limit=100');
                const logs = await logsResponse.json();
                logs.reverse().forEach(log => addLogEntry(log));
                
                // Load stats
                await updateStats();
            } catch (error) {
                console.error('Failed to load initial data:', error);
            }
        }
        
        // Update process list
        function updateProcessList(processes) {
            const container = document.getElementById('process-list');
            container.innerHTML = '';
            
            // Add "All Processes" option
            const allCard = document.createElement('div');
            allCard.className = 'process-card' + (!selectedProcess ? ' selected' : '');
            allCard.onclick = () => selectProcess(null);
            allCard.innerHTML = `
                <div class="process-name">All Processes</div>
                <div class="process-info">View logs from all processes</div>
            `;
            container.appendChild(allCard);
            
            // Add individual processes
            processes.forEach(processName => {
                const card = document.createElement('div');
                card.className = 'process-card' + (selectedProcess === processName ? ' selected' : '');
                card.onclick = () => selectProcess(processName);
                
                card.innerHTML = `
                    <span class="process-status running"></span>
                    <div class="process-name">${processName}</div>
                    <div class="process-info">Click to filter logs</div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // Select a process to filter logs
        function selectProcess(processName) {
            selectedProcess = processName;
            
            // Update UI
            document.querySelectorAll('.process-card').forEach((card, index) => {
                card.classList.toggle('selected', 
                    index === 0 ? !processName : card.querySelector('.process-name').textContent === processName
                );
            });
            
            // Filter logs
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                const show = !processName || entry.dataset.process === processName;
                entry.style.display = show ? 'flex' : 'none';
            });
        }
        
        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                stats = await response.json();
                updateStatsDisplay(stats);
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }
        
        // Update statistics display
        function updateStatsDisplay(stats) {
            document.getElementById('total-logs').textContent = `Total Logs: ${stats.totalLogs}`;
            document.getElementById('active-processes').textContent = `Active Processes: ${stats.processes}`;
            document.getElementById('correlation-count').textContent = `Correlations: ${stats.correlations}`;
            document.getElementById('logs-per-minute').textContent = stats.logsPerMinute || 0;
            document.getElementById('recent-errors').textContent = stats.errorsLast5Min || 0;
            document.getElementById('total-correlations').textContent = stats.correlations || 0;
            
            // Update level stats
            const levelStats = document.getElementById('level-stats');
            levelStats.innerHTML = '';
            Object.entries(stats.logsByLevel || {}).forEach(([level, count]) => {
                levelStats.innerHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span class="log-level ${level}" style="text-transform: uppercase;">${level}</span>
                        <span>${count}</span>
                    </div>
                `;
            });
            
            // Update process stats
            const processStats = document.getElementById('process-stats');
            processStats.innerHTML = '';
            Object.entries(stats.logsByProcess || {}).forEach(([process, count]) => {
                processStats.innerHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.875rem;">
                        <span style="color: #a78bfa;">${process}</span>
                        <span>${count}</span>
                    </div>
                `;
            });
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.className = 'connection-indicator connected';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'connection-indicator disconnected';
                text.textContent = 'Disconnected';
            }
        }
        
        // Update process status
        function updateProcessStatus(processId, status) {
            const cards = document.querySelectorAll('.process-card');
            cards.forEach(card => {
                const nameEl = card.querySelector('.process-name');
                if (nameEl && nameEl.textContent === processId) {
                    const statusEl = card.querySelector('.process-status');
                    if (statusEl) {
                        statusEl.className = `process-status ${status}`;
                    }
                }
            });
        }
        
        // Clear logs
        function clearLogs() {
            if (confirm('Clear all displayed logs?')) {
                document.getElementById('log-container').innerHTML = '';
                allLogs = [];
            }
        }
        
        // Export logs
        async function exportLogs(format) {
            const processParam = selectedProcess ? `&process=${selectedProcess}` : '';
            window.open(`/api/export?format=${format}${processParam}`);
        }
        
        // Highlight correlations
        function highlightCorrelations(correlationIds) {
            // Visual feedback for correlated logs
            setTimeout(() => {
                correlationIds.forEach(id => {
                    const elements = document.querySelectorAll(`.correlation-id:contains("${id}")`);
                    elements.forEach(el => {
                        el.style.animation = 'pulse 1s';
                    });
                });
            }, 100);
        }
        
        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>