{
  "type": "sequence",
  "id": "continuous-testing-workflow",
  "description": "Comprehensive CI/CD-style testing workflow for web applications",
  "children": [
    {
      "type": "parallel",
      "id": "pre-test-setup",
      "description": "Set up testing environment in parallel",
      "successPolicy": "all",
      "children": [
        {
          "type": "action",
          "id": "find-test-port",
          "tool": "portManager",
          "params": {
            "action": "find",
            "startPort": 4000,
            "endPort": 4100
          }
        },
        {
          "type": "action",
          "id": "setup-test-browser",
          "tool": "browserManager",
          "params": {
            "action": "launch",
            "browserName": "ci-browser",
            "headless": true,
            "viewport": {"width": 1920, "height": 1080}
          }
        },
        {
          "type": "action",
          "id": "setup-mobile-browser",
          "tool": "browserManager",
          "params": {
            "action": "launch",
            "browserName": "mobile-browser",
            "headless": true,
            "viewport": {"width": 375, "height": 812}
          }
        }
      ]
    },
    {
      "type": "sequence",
      "id": "build-and-serve",
      "description": "Build and serve the application",
      "children": [
        {
          "type": "retry",
          "maxAttempts": 2,
          "retryDelay": 1000,
          "child": {
            "type": "action",
            "id": "clean-install",
            "tool": "npmInstaller",
            "params": {
              "packageManager": "npm",
              "forceClean": true,
              "timeout": 300000
            }
          }
        },
        {
          "type": "action",
          "id": "build-production",
          "tool": "buildRunner",
          "params": {
            "command": "build",
            "packageManager": "npm",
            "timeout": 180000
          }
        },
        {
          "type": "action",
          "id": "start-test-server",
          "tool": "serverManager",
          "params": {
            "action": "start",
            "command": "preview",
            "port": "${find-test-port.port}",
            "serverName": "test-server",
            "waitForReady": true,
            "readyTimeout": 20000
          }
        }
      ]
    },
    {
      "type": "parallel",
      "id": "comprehensive-testing",
      "description": "Run all tests in parallel",
      "successPolicy": "all",
      "children": [
        {
          "type": "sequence",
          "id": "desktop-testing",
          "description": "Desktop browser testing",
          "children": [
            {
              "type": "action",
              "id": "desktop-screenshot",
              "tool": "screenshotCapture",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "ci-browser",
                "type": "fullPage",
                "fileName": "ci-desktop-full.png",
                "waitFor": 2000
              }
            },
            {
              "type": "action",
              "id": "desktop-performance",
              "tool": "performanceTester",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "ci-browser",
                "metrics": ["FCP", "LCP", "CLS", "FID", "TTFB", "DOMLoad", "WindowLoad"],
                "runs": 3,
                "waitTime": 2000
              }
            },
            {
              "type": "action",
              "id": "desktop-interactions",
              "tool": "interactionTester",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "ci-browser",
                "interactions": [
                  {"type": "wait", "timeout": 2000},
                  {"type": "click", "selector": "button", "continueOnError": true},
                  {"type": "wait", "timeout": 1000},
                  {"type": "scroll", "x": 0, "y": 500},
                  {"type": "wait", "timeout": 500},
                  {"type": "scroll", "x": 0, "y": 1000},
                  {"type": "wait", "timeout": 500},
                  {"type": "scroll", "x": 0, "y": 0},
                  {"type": "wait", "timeout": 1000}
                ],
                "screenshotAfterEach": false
              }
            }
          ]
        },
        {
          "type": "sequence",
          "id": "mobile-testing",
          "description": "Mobile browser testing",
          "children": [
            {
              "type": "action",
              "id": "mobile-screenshot",
              "tool": "screenshotCapture",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "mobile-browser",
                "type": "fullPage",
                "fileName": "ci-mobile-full.png",
                "waitFor": 2000
              }
            },
            {
              "type": "action",
              "id": "mobile-performance",
              "tool": "performanceTester",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "mobile-browser",
                "metrics": ["FCP", "LCP", "CLS"],
                "runs": 2,
                "waitTime": 1500
              }
            },
            {
              "type": "action",
              "id": "mobile-interactions",
              "tool": "interactionTester",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "mobile-browser",
                "interactions": [
                  {"type": "wait", "timeout": 1000},
                  {"type": "scroll", "x": 0, "y": 300},
                  {"type": "wait", "timeout": 500},
                  {"type": "click", "selector": "button", "continueOnError": true},
                  {"type": "wait", "timeout": 500},
                  {"type": "scroll", "x": 0, "y": 0}
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "type": "sequence",
      "id": "visual-regression-testing",
      "description": "Visual regression testing",
      "children": [
        {
          "type": "selector",
          "id": "baseline-check",
          "description": "Create baseline or compare with existing",
          "children": [
            {
              "type": "action",
              "id": "create-baseline-if-needed",
              "tool": "visualRegressionTester",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "ci-browser",
                "generateBaseline": true
              }
            },
            {
              "type": "action",
              "id": "compare-with-baseline",
              "tool": "visualRegressionTester",
              "params": {
                "url": "http://localhost:${find-test-port.port}",
                "browserName": "ci-browser",
                "baselineImage": "${existing_baseline}",
                "threshold": 0.02
              }
            }
          ]
        }
      ]
    },
    {
      "type": "sequence",
      "id": "test-cleanup",
      "description": "Clean up test resources",
      "children": [
        {
          "type": "parallel",
          "id": "close-browsers",
          "successPolicy": "any",
          "children": [
            {
              "type": "action",
              "id": "close-ci-browser",
              "tool": "browserManager",
              "params": {
                "action": "close",
                "browserName": "ci-browser"
              }
            },
            {
              "type": "action",
              "id": "close-mobile-browser",
              "tool": "browserManager",
              "params": {
                "action": "close",
                "browserName": "mobile-browser"
              }
            }
          ]
        },
        {
          "type": "action",
          "id": "stop-test-server",
          "tool": "serverManager",
          "params": {
            "action": "stop",
            "serverName": "test-server"
          }
        },
        {
          "type": "action",
          "id": "free-test-port",
          "tool": "portManager",
          "params": {
            "action": "kill",
            "port": "${find-test-port.port}"
          }
        }
      ]
    }
  ]
}